{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% bootstrap_messages %}
{% block references %}
<link rel="stylesheet" href="{% static "bible_tracker/css/style.css" %}" />
{% endblock %}
{% block content %}
<script type="text/javascript" src="/static/js/moment.min.js"></script>
<script type="text/javascript">
/****** START UP ******/
    //Daily Bible reading is default page. Second-year bible reading disabled for first-year trainees.
    $( document ).ready(function() {
        setWeeks();
        $("#select_menu option[id='{{current_week}}']").attr("selected", "selected");
        setDatesforWeek({{current_week}});
        //Disable Second-year tab for first-years?
    });
    /****** METHODS FOR DAILY BIBLE READING ******/
    /****** METHODS FOR FIRST AND SECOND YEAR BIBLE READING ******/
    function setWeeks(){
        var firstDayofWeek = moment(firstDayofTerm, "YYYYMMDD");
        var lastDayofWeek = firstDayofWeek.clone().add(6,'days');
        for (i = 0; i < 20; i++) { 
            $("#select_menu").append($("<option />").val("week-"+i).text("Week "+i+": "+firstDayofWeek.format("ddd MMM D")+" - "+lastDayofWeek.format("ddd MMM D")).attr('id',i));
            firstDayofWeek = lastDayofWeek.add(1,'day');
            lastDayofWeek = firstDayofWeek.clone().add(6,'days');
        }
    }
    function setDatesforWeek(week){
        var firstDay = moment(firstDayofTerm, "YYYYMMDD");
        var firstDayofWeek = firstDay.add(week,'weeks');
        for (var i = 0; i < 7; i++) {
            $("#day-"+i).html(firstDayofWeek.format("ddd - MMM D"));
            firstDayofWeek.add(1,'days');
        }
    }
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
    // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) == (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
        }
}
}
return cookieValue;
}

    function post(path, params, method) {
        method = method || "post"; // Set method to post by default if not specified.
        // The rest of this code assumes you are not using a library.
        // It can be made less wordy if you use one.
        var form = document.createElement("form");
        form.setAttribute("method", method);
        form.setAttribute("action", path);
        for(var key in params) {
            if(params.hasOwnProperty(key)) {
                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", key);
                hiddenField.setAttribute("value", params[key]);
                form.appendChild(hiddenField);
            }
        }
        document.body.appendChild(form);
        form.submit();
    }
    function modify_boxes(classname){
        var x = document.getElementsByClassName(classname)[0];
        x.setAttribute("checked", "true");
    }
    var first_year_progress = {{first_year_progress}};
    var second_year_progress = {{second_year_progress}};
    var firstDayofTerm = String({{start_date}});

    function changeWeek(){
    var weekid = $("#select_menu").find('option:selected').attr('id');
     $('.btn.btn-primary.active').removeClass('active');
     console.log(weekid);
     $.ajax({
        type:"GET",
        url: "{% url 'bible_tracker:changeWeek' %}",
        data: {
            'week':weekid,
            csrfmiddlewaretoken: getCookie('csrftoken')
        },
        success: function(data){
            setDatesforWeek(parseInt(weekid));
            var res = data.split("");
            for (i = 0; i < res.length; i++) { 
             $('#status-day-'+i).find("input#"+res[i]).parent().addClass("active");
            }
        },

    });    
    }

    function updateStatus(){
        var weekly_status=''
        //$('#status-day-'+id+' input:radio:checked').prop("checked", true); 
        for (i = 0; i < 7; i++) { 
            day_status = $('#status-day-'+ i +' input:radio:checked').val();
            console.log(day_status);
            if (day_status == null){
                weekly_status+= '_';
            }
            else{
                weekly_status+= day_status;
            }
        }
        console.log(weekly_status);
        var week_id =  $('#select_menu').find(":selected").attr('id');
        $.ajax({
            type:"POST",
            url: "{% url 'bible_tracker:updateStatus' %}",
            data: {
                'week_id':week_id,
                'weekly_status':weekly_status,
                csrfmiddlewaretoken: getCookie('csrftoken')
            },
            success: function(data){
                $('#message').html("<h4>Saved</h4>");
            },

        });    
    }

    function toggleCheckbox(classname, id, year) {
        if (document.getElementsByClassName(classname)[0].checked == true ){
            $.ajax({
                type:"POST",
                url: "{% url 'bible_tracker:index' %}",
                data: {
                    'book':id,
                    'year': year,
                    'checked': true,
                    csrfmiddlewaretoken: getCookie('csrftoken')
                },
                success: function(data){
                    $('#message').html("<h4>Saved</h4>");
                    if(year==1) {
                        $("#first-year-prog").css("width", data+"%");
                        $("#first-year-prog").html(data+"%");
                        $("#first-year-prog").attr("aria-valuenow", data);
                    } else if(year==2) {
                        $("#second-year-prog").css("width", data+"%");
                        $("#second-year-prog").html(data+"%");
                        $("#second-year-prog").attr("aria-valuenow", data);
                    }
                }
            });
        } else {
            $.ajax({
                type:"POST",
                url: "{% url 'bible_tracker:index' %}",
                data: {
                    'book':id,
                    'year': year,
                    'checked': false,
                    csrfmiddlewaretoken: getCookie('csrftoken')
                },
                success: function(data){
                    $('#message').html("<h4>Deleted</h4>");
                    if(year==1) {
                        $("#first-year-prog").css("width", data+"%");
                        $("#first-year-prog").html(data+"%");
                        $("#first-year-prog").attr("aria-valuenow", data);
                    } else if(year==2) {
                        $("#second-year-prog").css("width", data+"%");
                        $("#second-year-prog").html(data+"%");
                        $("#second-year-prog").attr("aria-valuenow", data);
                    }
                }
            });

        }

    }
</script>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist" style="margin-bottom: 25px;">
    <li role="presentation" class="active"><a href="#daily-bible-reading" aria-controls="home" role="tab" data-toggle="tab">Daily Reading</a></li>
    <li role="presentation"><a href="#first-year-bible-reading" aria-controls="profile" role="tab" data-toggle="tab">First Year</a></li>
    <li role="presentation"><a href="#second-year-bible-reading" aria-controls="messages" role="tab" data-toggle="tab">Second Year</a></li>
</ul>
<!-- TAB PANES -->
<div class="tab-content">
    <div id="daily-bible-reading" class="bible-reading tab-pane active" role="tabpanel" >
        <form name="dailyBibleReading" id="dailyBibleReadingEntry" method="post" action="">
            <!-- Pick a week of a term -->
            <b>Week Of: </b>
            <select id="select_menu" class="form-control" name="week" size="0" onchange="changeWeek()">
            </select>
            <br>
            <br>
            <!-- Bible Reading Table -->
            <form class="form-horizontal">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-highlight">
                        {% for date in weekly_status%}
                        <tr>
                         <th id="day-{{ forloop.counter0 }}" ></th>
                    <td>
                        <div class="btn-group" data-toggle="buttons" id="status-day-{{forloop.counter0}}">
                          <label class="btn btn-primary btn-success" id='complete'>
                            <input type="radio" name="options-{{forloop.counter0}}" id="C" value='C'>C
                        </label>
                        <label class="btn btn-primary btn-warning">
                            <input type="radio" name="options-{{forloop.counter0}}" id="M" value='M'>M
                        </label>
                        <label class="btn btn-primary btn-danger">
                            <input type="radio" name="options-{{forloop.counter0}}" id="N" value='N'>N
                        </label>
                    </div>
               </td>
                    </tr>
                    {% endfor %}
                
            </table>
        </div>

    </form>
    <!-- Description -->
    <p>Valid Statuses: <b><u>C</u></b>ompleted, <b><u>M</u></b>ake-up, <b><u>N</u></b>ot Read</p>
    <p>C: I <b>completed</b> 20 minutes of Bible reading for selected date. <br>
        M: I <b>made up</b> 20 minutes of Bible reading for selected date. <br>
        N: I did <b>not</b> complete 20 minutes of Bible reading for selected date.</p><br>
        <br><br>
        <!-- Save and Finalize buttons -->
         <input class="btn btn-default" type="submit" name="save" Value="Save" id='save' onClick="updateStatus()">
        <input class="btn btn-default" disabled="disabled" type="submit" name="finalize" id='finalize' Value="Finalize" onClick="javascript:return confirm('Are you sure you want to finalize?')">
    </form>
</div>
<!-- DAILY BIBLE READING -->
<!-- FIRST YEAR BIBLE READING PAGE -->
<div id="first-year-bible-reading" class="bible-reading tab-pane" role="tabpanel">
    <div class="progress">
        <div id="first-year-prog" class="progress-bar" role="progressbar" aria-valuenow="{{first_year_progress}}" aria-valuemin="0" aria-valuemax="100" style="width: {{first_year_progress}}%;">{{first_year_progress}}%</div>
    </div>
    <div class = "old-testament">
        <h4>Old Testament</h4>
        {% for choice in bible_books_list|slice:":39" %}

        <label style="font-weight: normal"> <input class="first-year{{forloop.counter0}}" type="checkbox" onchange="toggleCheckbox('first-year{{forloop.counter0}}', {{forloop.counter0}}, 1)" name="book" id="{{ forloop.counter0 }}" value="{{ forloop.counter0  }}" /> {{ choice }}</label><br />
        {% endfor %}
    </div>
    <div class = "new-testament">
        <h4>New Testament</h4>
        {% for choice in bible_books_list|slice:"39:" %}

        <label style="font-weight: normal"> <input class="first-year{{forloop.counter0|add:39}}" type="checkbox" onchange="toggleCheckbox('first-year{{forloop.counter0|add:39}}', {{forloop.counter0|add:39}}, 1)" name="book" id="{{ forloop.counter0|add:39 }}" value="{{ forloop.counter0|add:39 }}" /> {{ choice }} </label><br />
        {% endfor %}
    </div>
</div>
<!-- Checking First-year boxes -->
{% for checked in first_year_checked_list %}
<script>
modify_boxes("first-year{{checked}}");
</script>
{% endfor %}
<!-- SECOND YEAR BIBLE READING PAGE -->
<div id="second-year-bible-reading" class="bible-reading tab-pane" role="tabpanel">
    <div class="progress">
        <div id="second-year-prog" class="progress-bar progress-bar-second" role="progressbar" aria-valuenow="{{second_year_progress}}" aria-valuemin="0" aria-valuemax="100" style="width: {{second_year_progress}}%;">{{second_year_progress}}%</div>
    </div>
    <div class = "new-testament">
        <h4>New Testament</h4>
        {% for choice in bible_books_list|slice:"39:" %}
        <label style="font-weight: normal">                  
            <input class="second-year{{forloop.counter0|add:39}}" type="checkbox" onchange="toggleCheckbox('second-year{{forloop.counter0|add:39}}', {{forloop.counter0|add:39}}, 2)" name="book" id="{{ forloop.counter0|add:39}}" value="{{ forloop.counter0|add:39 }}" /> {{ choice }} (notes)</label><br />
            {% endfor %}
        </div>
    </div>
    <!-- Checking Second-year boxes -->
    {% for checked in second_year_checked_list %}
    <script>
        modify_boxes("second-year{{checked}}");
    </script>
    {% endfor %}

    {% for status in weekly_status%}
    <script>
        $('#status-day-{{forloop.counter0}}').find("input#{{status}}").parent().addClass("active");
    </script>
    {% endfor %}
</div>
<div id="message" style="float:left"></div>
{% endblock %}