{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% bootstrap_messages 
{% block title %}Bible Tracker Reports{% endblock %}
{% block references %}
{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/s/bs/jszip-2.5.0,pdfmake-0.1.18,dt-1.10.10,b-1.1.0,b-flash-1.1.0,b-html5-1.1.0,b-print-1.1.0,fh-3.1.0,sc-1.4.0/datatables.min.css"/>
<link rel="stylesheet" ref="{% static "bible_tracker/css/printstyle.css" %}" type"text/css" media="print" />
<script type="text/javascript" src="/static/js/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/s/bs/jszip-2.5.0,pdfmake-0.1.18,dt-1.10.10,b-1.1.0,b-flash-1.1.0,b-html5-1.1.0,b-print-1.1.0,fh-3.1.0,sc-1.4.0/datatables.min.js"></script>
<script type="text/javascript">
/****** START UP ******/
    //Daily Bible reading is default page. Second-year bible reading disabled for first-year trainees.
    var options={{stat_option2 }};

    $( document ).ready(function() {
        $('table.data-table').DataTable({
      paging: false,
      columnDefs: [{
        targets: 'no-sort',
        orderable: false
      }],
      dom: '<"row"<"col-sm-6"Bl><"col-sm-6"f>>' +
        '<"row"<"col-sm-24"<"table-responsive"tr>>>' +
        '<"row"<"col-sm-5"i><"col-sm-7"p>>',
      fixedHeader: {
        header: true
      },
      buttons: {
        buttons: [{
          extend: 'print',
          text: '<i class="fa fa-print"></i> Print',
          title: $('h1').text(),
          exportOptions: {
            columns: ':not(.no-print)'
          },
          customize: function ( win ) {
                    $(win.document.body)
                        .css( 'font-size', '12pt' )
                        );
 
                    $(win.document.body).find( 'table' )
                        .addClass( 'cell-border' )
                        .css( 'font-size', 'inherit' )
                        .css('border', '1px solid black');
                },
        }, {
          extend: 'pdf',
          text: '<i class="fa fa-file-pdf-o"></i> PDF',
          title: $('h1').text(),
          exportOptions: {
            columns: ':not(.no-print)'
          },
        }],
        dom: {
          container: {
            className: 'dt-buttons'
          },
          button: {
            className: 'btn btn-default'
          }
        }
      }
    });

   	console.log(options);
   	setWeeks();
    $("#extra_options").hide();

   	$('#more').click(function(){
        $("#extra_options").toggle();
    });
    for (i=3; i<15; i++){
    	$("#results").find('tr :nth-child(' + (i + 1) + ')').toggle();
        $("#results").find('tr :nth-child(' + (i + 1) + ')').addClass("no-print");
    }
    for (i=0; i<options.length; i++){
    	$("#results").find('tr :nth-child(' + (options[i]+ 1) + ')').toggle();
        $("#results").find('tr :nth-child(' + (options[i]+ 1) + ')').removeClass("no-print")
        $('#bible_reading_report input[value='+options[i]+']').prop('checked', true);
    }
    $("input#cutoff_range").val('{{cutoff_range}}');
    $("#start_range option[id='{{ start_week }}']").attr("selected", "selected");
    $("#end_range option[id='{{ end_week }}']").attr("selected", "selected");
    });
    /****** METHODS FOR DAILY BIBLE READING ******/
    /****** METHODS FOR FIRST AND SECOND YEAR BIBLE READING ******/
    var firstDayofTerm = "{{start_date}}";
    function setWeeks(){
        var firstDayofWeek = moment(firstDayofTerm, "YYYYMMDD");
        var lastDayofWeek = firstDayofWeek.clone().add(6,'days');
        for (i = 0; i < 20; i++) { 
            $("#start_range").append($("<option />").val(i).text("Week "+i+": "+firstDayofWeek.format("ddd MMM D")).attr('id',i));
            $("#end_range").append($("<option />").val(i).text("Week "+i+": "+lastDayofWeek.format("ddd MMM D")).attr('id',i));
            firstDayofWeek = lastDayofWeek.add(1,'day');
            lastDayofWeek = firstDayofWeek.clone().add(6,'days');
        }
	}
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
    // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) == (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
        }
}
}
return cookieValue;
}
    function updateStatus(){
        var weekly_status=''
        for (i = 0; i < 7; i++) { 
            day_status = $('#status-day-'+ i +' label.active input').val();
            console.log(day_status);
            if (day_status == null){
                weekly_status+= '_';
            }
            else{
                weekly_status+= day_status;
            }
        }
        var week_id =  $('#select_menu').find(":selected").attr('id');
        $.ajax({
            type:"POST",
            url: "{% url 'bible_tracker:updateStatus' %}",
            data: {
                'week_id':week_id,
                'weekly_status':weekly_status,
                csrfmiddlewaretoken: getCookie('csrftoken')
            },
            success: function(data){
                $('#save').blur();
                $('#saved').show();
                $("#saved").fadeOut(2000); 
            },

        });    
    }

</script>
<h2>Bible Reading Daily Report</h2>
<form id="bible_reading_report" method="get" action="/bible_tracker/generateReport/">
		{% csrf_token %} 
			<!-- start_range (Monday) -->
			From Monday: <select id="start_range" name="start_range"></select>
			<!-- end_range (Lord's day) -->
			To Lord's day: <select id="end_range" name="end_range"> </select><br><br>
			<!-- cutoff percent -->
			Show trainees who have completed LESS THAN <br>
 			<input type="text" name="cutoff_range" id="cutoff_range" value="100" maxlength="4" size="4" onchange="updateSlider(this.value);">
			% of their completed (C+M%) readings. <i>(All trainees will show if 100% is selected.)</i>
			<br><br>
			<input type="checkbox" name="stats[]" value="3" checked />
			% of (completed + made-up) readings (C+M%) <br />
            <input type="checkbox" name="stats[]" value="4" />
            1st Year Bible Reading (1st%) <br />
            <input type="checkbox" name="stats[]" value="5" />
            2nd year Bible Reading (2nd%) <br />
            <button type="button" class="btn btn-default btn-sm" id="more">
                 <span class="glyphicon glyphicon-plus"></span> More
            </button>
            <br>
            <div id ="extra_options">
            <input type="checkbox" name="stats[]" value="6" />
            # of (completed + made-up) readings (C+M#)<br />
			<input type="checkbox" name="stats[]" value="7" />
			# of completed readings (C#)<br />
			<input type="checkbox" name="stats[]" value="8" />
			% of completed reading (C%) <br />
			<input type="checkbox" name="stats[]" value="9" />
			# of made-up readings (M#) <br />
			<input type="checkbox" name="stats[]" value="10" />
			% of made-up readings (M%) <br />
			<input type="checkbox" name="stats[]" value="11" />
			# of not-read readings (N#) <br />
			<input type="checkbox" name="stats[]" value="12" />
			% of not-read readings (N%) <br />
			<input type="checkbox" name="stats[]" value="13" />
			# of blank fields (B#) <br />
            <input type="checkbox" name="stats[]" value="14" />
			% of blank fields (B%) <br />   
            </div>                 
			<br />
			<input type="submit" class= "btn" name="generate" value="Generate Report" />
		</form>
        <br>
<div class="data-table-container">

	{%if trainee_stats%}
<table class="table table-hover table-striped table-bordered data-table" id="results">
	<thead>
	<tr>
	<th>Firstname</th>
	<th>Lastname</th>
	<th>Term</th>
    <th>C+M%</th>
    <th>1st%</th>
    <th>2nd%</th>
	<th>C+M#</th>
	<th>C#</th>
	<th>C%</th>
	<th>M#</th>
	<th>M%</th>
	<th>N#</th>
	<th>N%</th>
	<th>B#</th>
	<th>B%</th>
</tr>
</thead>
      {% for trainee_stat in trainee_stats%}
      <tr>
		<td>{{trainee_stat.firstname}}</td>
		<td>{{trainee_stat.lastname}}</td>
		<td>{{trainee_stat.current_term}}</td>
        <td>{{trainee_stat.percent_complete_madeup}}</td>
        <td>{{trainee_stat.percent_firstyear}}</td>
        <td>{{trainee_stat.percent_secondyear}}</td>
		<td>{{trainee_stat.number_complete_madeup}}</td>
		<td>{{trainee_stat.number_complete}}</td>
		<td>{{trainee_stat.percent_complete}}</td>
		<td>{{trainee_stat.number_madeup}}</td>
		<td>{{trainee_stat.percent_madeup}}</td>
		<td>{{trainee_stat.number_notread}}</td>
		<td>{{trainee_stat.percent_notread}}</td>
		<td>{{trainee_stat.number_blank}}</td>
		<td>{{trainee_stat.percent_blank}}</td>

		 {% endfor %}
	</tr>
</table>
{% endif %}
</div>
{% endblock %}
