{% extends "exams/base_exams.html" %}

{% load staticfiles %}
{% load bootstrap3 %}
{% load exam_filters %}
{% load common_tags %}

{% block title %}{% if exam_edit %}Edit{% else %}Create{% endif %} Exam{% endblock %}

{% block scripts %}
<script type="text/javascript" src="{% static "exams/js/exam-create-save-post.js" %}"></script>
<script>
  /* Store global variables here
  */
  const SUCCESS_URL = "{{view.get_success_url}}";
</script>
<script>

  function addSection(e) {
    var section_div = $("#exam_section_blank").clone();
    section_div.removeAttr("id");
    section_div.removeClass("hidden");
    $("#sections").append(section_div);
  }

  function GetDynamicTextBox(value) {
    switch(value) {
      case "E":
        return $('#essay-question-template-blank').html();
        break;
      case "MC":
        return $('#mc-question-template-blank').html();
        break;
      case "M":
        return $('#matching-question-template-blank').html();
        break;
      case "TF":
        return $('#tf-question-template-blank').html();
        break;
      case "FB":
        return $('#fitb-question-template-blank').html();
        break;
      default:
        return "";
    }
  }

  function addQuestion(e) {
    var type = $(e.target).parent().parent().find("[name='section_type']").val();
    $(e.target).parent().parent().find(".QuestionsContainer").append(GetDynamicTextBox(type));
  }

  function addCheckbox(e) {
    var container = $(e.target).parent().parent().find("[id='MCCheckboxes']");
    var inputs = container.find('input');
    var id = inputs.length+1;
    list_node = '<li><input type="checkbox" name="' + id + '" value=""> <textarea name="question-option-' + id + '" class="question form-control" placeholder="Enter choice"></textarea></li>'
    container.append(list_node);
  }

  function removeCheckbox(e) {
    var container = $(e.target).parent().parent().find("[id='MCCheckboxes']");
    var last_checkbox = container.children('li').length - 1;
    container.children('li')[last_checkbox].remove();
  }

  function addAnswer(e) {
    var container = $(e.target).parent().parent().find("[id='fitb_answer_div']");
    var number_of_answers = container.children('li').length;

    var name = "answer-text-" + (number_of_answers+1).toString();
    var placeholder = "Answer to $" + (number_of_answers+1).toString();
    list_node = '<li><textarea name="'+name+'" class="question form-control" placeholder="'+placeholder+'"></textarea></li>'
    container.append(list_node);
  }

  function removeAnswer(e) {
    var container = $(e.target).parent().parent().find("[id='fitb_answer_div']");
    container.children().last().remove()
  }

  $(document).ready(() => {
    tf_question_count = $('*[id*=tf_]:visible').length;
    $("body").on("click", ".remove.section", function () {
      $(this).closest("div.section").remove();
    }).on("click", ".remove.question", function () {
      $(this).closest("div.question").remove();
    }).on("click", "#btnAddSection", function(e) {
      addSection(e);
    }).on("click", "#btnAddQuestion", function(e) {
      addQuestion(e);
    }).on("click", "#add_choice_button", function(e) {
      addCheckbox(e);
    }).on("click", "#remove_choice_button", function(e) {
      removeCheckbox(e);
    }).on("click", "#fitb-add-answer-button", function(e) {
      addAnswer(e);
    }).on("click", "#fitb-remove-answer-button", function(e) {
      removeAnswer(e);
    });

    $(document).on('mousedown', 'select[name="section_type"]', (e) => {
      if ($(e.target).closest('.section').find('.QuestionsContainer').children().length != 0) {
        e.preventDefault();
        this.blur();
        window.focus();
        alert('Cannot change section type if questions already exist.');
      }
    });
  });

</script>

{% endblock %}


{% block content %}
<form action="" id="surveyForm" method="post" class="form-horizontal">
  {% csrf_token %}
  <h3>{% if exam_edit %}Edit{% else %}Create{% endif %} Exam</h3>
  <hr>
  <div class="form-horizontal" name="exam_metadata">
    {% bootstrap_field form.training_class label_class="col-md-2" field_class="col-md-4" %}
    {% bootstrap_field form.term label_class="col-md-2" field_class="col-md-4" %}
    {% bootstrap_field form.description label_class="col-md-2" field_class="col-md-4" %}

    <!-- Is the exam open -->
    <div class="form-group">
      <label class="col-md-2 control-label" for="is_open">Is Open</label>
      <div class="col-md-4">
        <div class="btn-group" data-toggle="buttons">
          <label class="btn btn-default {% if is_open %}active{% endif %}">
            <input type="radio" autocomplete="off" name="is_open" id="radios-0" value="True" {% if is_open %}checked{% endif %}> Yes
          </label>
          <label class="btn btn-default {% if not is_open %}active{% endif %}">
            <input type="radio" autocomplete="off" name="is_open" id="radios-1" value="False" {% if not is_open %}checked{% endif %}> No
          </label>
        </div>
      </div>
    </div>

    <!-- Exam Category -->
    <div class="form-group">
      <label class="col-md-2 control-label" for="exam_category">Category</label>
      <div class="col-md-4">
        <div class="btn-group" data-toggle="buttons">
          <label class="btn btn-default {% if not is_final %}active{% endif %}">
            <input type="radio" autocomplete="off" name="exam_category" id="radios-0" value="M" {% if not is_final %}checked{% endif %}> Midterm
          </label>
          <label class="btn btn-default {% if is_final %}active{% endif %}">
            <input type="radio" autocomplete="off" name="exam_category" id="radios-1" value="F" {% if is_final %}checked{% endif %}> Final
          </label>
        </div>
      </div>
    </div>

    <!-- Exam duration-->
    {% bootstrap_field form.duration label_class="col-md-2" field_class="col-md-4" %}
  </div>

  <!-- Empty div for creating sections -->
  <h3>Sections
    <div class="pull-right">
      <input id="btnAddSection" class="btn btn-danger" type="button" value="Add Section" />
    </div>
  </h3>
  <hr>
  <div id="sections">
  <!--fix: for section in data (from utils get_edit_context_data) include each as an exam_section-->
    {% for section in data %}
      {% include 'exams/exam_section.html' %}
    {% endfor %}
  </div>

<!-- Hidden template section for copying and adding -->
{% include 'exams/exam_section.html' with id="id='exam_section_blank'" hidden='hidden' %}
{% include 'exams/mc_question.html' with attrs="class='hidden' id='mc-question-template-blank'" %}
{% include 'exams/essay_question.html' with attrs="class='hidden' id='essay-question-template-blank'" %}
{% include 'exams/matching_question.html' with attrs="class='hidden' id='matching-question-template-blank'" %}
{% include 'exams/tf_question.html' with attrs="class='hidden' id='tf-question-template-blank'" %}
{% include 'exams/fitb_question.html' with attrs="class='hidden' id='fitb-question-template-blank'" %}


  <!-- Create Exam Button -->
 <button id="exam-submit" name="" class="btn btn-success">
    {% if exam_edit %}
      Save Exam
    {% else %}
      Create Exam
    {% endif %}
  </button>
</form>

{% endblock %}
