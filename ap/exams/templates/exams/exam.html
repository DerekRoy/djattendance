{% extends "exams/base_exams.html" %}

{% load staticfiles %}
{% load exam_extras %}
{% load exam_filters %}
{% load common_tags %}

{% block title %}Exam{% endblock %}

{% block content %}
  {% if user|is_trainee %}
    <div class="panel panel-default">
      <div class="panel-heading exam-panel-heading">
        <div class="btn-group pull-right">
          {% if role == 'Take' %}
            <a href="{% url 'exams:list' %}">
              <button type="button" class="btn btn-default">Back</button></a>
          {% else %}
            <a href="{% url 'exams:grades' exam.id %}">
              <button type="button" class="btn btn-default">Back</button></a>
          {% endif %}
        </div>
        <h3 class="panel-title exam-panel-title">
          {% if role == 'Grade' %}
            {{ examinee.full_name }} -
          {% endif %}
            {{ exam }}
        </h3>
      </div>
      <div class="panel-body">
        {% if not exam_available %}
          <i>Sorry, this exam is unavailable to you at this time.</i>
        {% else %}
          <form id="exam_form" action="" method="post">
            {% csrf_token %}
            <ol id="question-list">
              <div id="question_count" value="{{ data|length }}"></div>
              {% for section, response in data %}
                <h3> {{ section.section_type }} </h3>
                <h5> Instructions: {{ section.instructions }} </h5>
                <input type="hidden" value="{{ section.id }}" name="section_id">
                <input type="hidden" value="{{ section.type }}" name="section_type">
                {% for question in section.questions %}
                  {% if section.type == 'E' %}
                    {% include 'exams/essay_question_template.html' %}
                  {% elif section.type == 'MC' %}
                    {% include 'exams/mc_question_template.html' %}
                  {% elif section.type == 'M' %}
                    {% include 'exams/matching_question_template.html' %}
                  {% elif section.type == 'TF' %}
                    {% include 'exams/tf_question_template.html' %}
                  {% elif section.type == 'FB' %}
                    {% include 'exams/fitb_question_template.html' %}
                  {% endif %}
                {% endfor %}
              {% empty %}
                <i>No exam questions to view.</i><br />
              {% endfor %}
            </ol>
            <div class="pull-right">
              <button id="save_button" name="Save" class="btn btn-success">Save</button>
              <button id="finalize_button" name="Submit" class="btn btn-primary">
                Finalize
              </button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  {% else %}
    {% include "exams/exam_grade.html" %}
  {% endif %}
{% endblock %}


{% block scripts %}
  <script>
  function selectOnlyThis(id) {
    cur_id = '#' + id;
    var this_div = $(cur_id).closest("div");
    numeral = parseInt(id.match(/\d+/));
    if ((numeral % 2) === 0) {
        document.getElementById("tf_" + (numeral - 1).toString()).checked = false;
    } else {
      document.getElementById("tf_" + (numeral + 1).toString()).checked = false;
    }
    document.getElementById(id).checked = true;
  }

  function attach_counter(textarea, index) {
    Countable.live(textarea, function(counter){
      var span = $('#count-' + index);
      span.html(counter.words);
    });
  }

  $(document).ready(function(e) {
    // Attach Countable to essay questions
    var textareas = $('.exam-response');
    for (var i = 0; i < textareas.length; i++) {
      var textarea = textareas[i];
      var index = $(textarea).attr('id').split('-')[1];
      attach_counter(textarea, index);
    }

    $("#exam_form").on("click", '#save_button, #finalize_button', e => {
      e.preventDefault()

      const form_data = $('#exam_form').serializeArray()
      //rtn_data = {SECTION_ID: {1:ANSWER1,2:ANSWER2,3:ANSWER3,...}, SECTION_ID: ...}
      let rtn_data = {}
      let current_ques_index = 1
      let current_section_type = '';
      let current_section_id = '-1';
      let current_fitb_index = 0;
      let current_section = {};
      let r = /\d+/;
      // Iterate through each input in form
      // Each time we hit a new section_id, we start a new section
      // The next input will be section_type.
      // Followed by responses, depending on the type of section
      form_data.forEach((v, i) => {
        // Here we start a new section
        if (v.name === "section_id") {
          current_ques_index = 1;
          current_section_id = v.value;
          rtn_data[current_section_id] = {}; //create new object for section_id
          current_section = rtn_data[current_section_id]
        }
        // On next loop we save the section type
        else if (v.name === "section_type") {
          current_section_type = v.value;
        }
        // Here we do different things based on section type
        else {
          switch (current_section_type){
            case "E":
              if(v.name === "response") {
                current_section[current_ques_index] = v.value
                current_ques_index++;
              }
              break;
            case "MC":
              if (/[0-9]+/.test(v.name)) {
                //value includes question number, name(s) are the answers student inputted
                if (current_section[v.value] != undefined) {
                  current_section[v.value] = current_section[v.value].concat(';').concat(v.name);
                } else {
                  current_section[v.value] = v.name;
                }
              }
              break;
            case "M":
              if(v.name === "matching_answer_field") {
                //BUG: every third time or random time the trainee saves it seems like some of the trainee responses gets messed up
                current_section[current_ques_index] = v.value;
                current_ques_index++;
              }
              break;
            case "TF":
              if (/true[0-9]+/.test(v.name)) {
                current_section[current_ques_index] = 'true';
                current_ques_index++;
              } else if (/false[0-9]+/.test(v.name)) {
                current_section[current_ques_index] = 'false';
                current_ques_index++;
              }
              break;
            case "FB":
              //check if form data name is a an answer textbox with the name: fitb-textarea-x
              if (/fitb-textarea-[0-9]+/.test(v.name)) {
                /** fitb index is the integer x in 'fitb-textarea-x', if x is less than current_fitb_index then it indicates
                a new question is reached and the fitb-textarea-x resets x to 1*/
                if (current_fitb_index >= parseInt(v.name.match(r))) {
                  current_ques_index++;
                }
                current_fitb_index = parseInt(v.name.match(r));
                //if something in response of trainee already:
                if (current_section[current_ques_index] != undefined) {
                  current_section[current_ques_index] = current_section[current_ques_index].concat(';').concat(v.value)
                } else {
                  current_section[current_ques_index] = v.value;
                }
              }
          }
        }
      })
      //rtn_data[e.target.name] ='true';
      if (e.currentTarget.id === "finalize_button") {
        rtn_data['Submit'] ='true';
      } else {
        rtn_data['Submit'] ='false';
      }
      console.log(rtn_data)
      $.ajax({
        type: 'POST',
        url: window.location.pathname,
        data: JSON.stringify(rtn_data),
        success: function (data, status, jqXHR) {
          if (data.ok) {
            location.reload();
          } else {
            console.log(data.msg)
          }
        },
        error: function (jqXHR, textStatus, errorThrown ) {
        }
      })

    })
  })
  </script>
{% endblock %}
