{% extends "exams/base_exams.html" %}

{% load staticfiles %}
{% load exam_extras %}
{% load common_tags %}

{% block title %}Exam{% endblock %}

{% block content %}
{% if user|is_trainee %}
  <div class="panel panel-default">
    <div class="panel-heading exam-panel-heading">
      <div class="btn-group pull-right">
        {% if role|is_taking_exam %}
          <a href="{% url 'exams:list' %}">
            <button type="button" class="btn btn-default">Back</button></a>
        {% else %}
          <a href="{% url 'exams:grades' exam.id %}">
            <button type="button" class="btn btn-default">Back</button></a>
        {% endif %}
      </div>
      <h3 class="panel-title exam-panel-title">
        {% if role == 'Grade' %}
        {{ examinee.full_name }} -
        {% endif %}
        {{ exam }}
      </h3>
    </div>
    <div class="panel-body">
    {% if exam_not_available %}
      <i>Sorry, this exam is unavailable to you at this time.</i>
    {% else %}
      <form id="exam_form" action="" method="post">
        {% csrf_token %}
        <ol id="question-list">

          <div id="question_count" value="{{ data|length }}"></div>
          {% for question, response in data %}

            <li>{{ question.prompt }}<b> (Points: {{ question.points }})</b></li>
            <br>
            <textarea class="form-control exam-response {% if role != 'Take' and role != 'Retake' %}disabled{% endif %}" id="response-{{ forloop.counter }}" cols="100" rows="10" placeholder="Type your response here." name="response" style="overflow: hidden; word-wrap: break-word; resize: horizontal; height: 206px;" {% if role != 'Take' and role != 'Retake' %} disabled="disabled"{% endif %}>{{ response.response }}</textarea>
            <br><b>Word Count: </b><span id="count-{{ forloop.counter }}">0</span>

            <!-- store interesting values for packaging later -->
            <div id="question_{{forloop.counter}}" value='{{ question|safe }}'/>
            <div id="response_{{forloop.counter}}" value='{{ response|safe }}' />

            {% if role == 'Grade' %}
              <br><b>Score: </b>
              <input class="score form-control" id="score-{{forloop.counter}}" type="text" name="question-score" value="{{ response.score }}"><b> Comment: </b>
              <input class="grader-comment form-control" id="comment-{{forloop.counter}}" type="text" name="grader-comment" value="{{ response.comment }}">
              <hr/>
            {% endif %}

          {% empty %}
            <i>No exam questions to view.</i><br />
          {% endfor %}

        </ol>

        <button name="Save" class="btn btn-default">Save</button>
        <button name="Submit" class="btn btn-default">
          {% if role|is_taking_exam %}
            Submit
          {% else %}
            Finalize
          {% endif %}
        </button>
      </form>
    {% endif %}

    </div>
  </div>
{% else %}
<i>Sorry, you cannot take the exam.</i>
{% endif %}

{% endblock %}


{% block scripts %}
  <script src="{% static 'js/Countable.js' %}"></script>
  <script>
  function attach_counter(textarea, index) {
    Countable.live(textarea, function(counter){
      console.log('index', index);
      var span = $('#count-' + index);
      span.html(counter.words);
    });
  }

  $(document).ready(function(e) {
    var textareas = $('.exam-response');
    for (var i = 0; i < textareas.length; i++) {
      var textarea = textareas[i];
      var index = $(textarea).attr('id').split('-')[1];
      attach_counter(textarea, index);
    }
  })
  </script>
{% endblock %}
