{% extends "exams/base_exams.html" %}

{% load staticfiles %}
{% load exam_extras %}
{% load exam_filters %}
{% load common_tags %}

{% block title %}Exam{% endblock %}

{% block content %}
  {% if user|is_trainee %}
    <div class="panel panel-default">
      <div class="panel-heading exam-panel-heading">
        <div class="btn-group pull-right">
          {% if role == 'Take' %}
            <a href="{% url 'exams:list' %}">
              <button type="button" class="btn btn-default">Back</button></a>
          {% else %}
            <a href="{% url 'exams:grades' exam.id %}">
              <button type="button" class="btn btn-default">Back</button></a>
          {% endif %}
        </div>
        <h3 class="panel-title exam-panel-title">
          {% if role == 'Grade' %}
            {{ examinee.full_name }} -
          {% endif %}
            {{ exam }}
        </h3>
      </div>
      <div class="panel-body">
        {% if not exam_available %}
          <i>Sorry, this exam is unavailable to you at this time.</i>
        {% else %}
          <form id="exam_form" action="" method="post">
            {% csrf_token %}
            <ol id="question-list">
              <div id="question_count" value="{{ data|length }}"></div>
              {% for section, response in data %}
                <h3> {{ section.section_type }} </h3>
                <h5> Instructions: {{ section.instructions }} </h5>
                <input type="hidden" value="{{ section.id }}" name="section_id">
                <input type="hidden" value="{{ section.type }}" name="section_type">
                {% for question in section.questions %}
                  {% if section.type == 'E' %}
                    {% include 'exams/essay_question_template.html' %}
                  {% elif section.type == 'MC' %}
                    {% include 'exams/mc_question_template.html' %}
                  {% elif section.type == 'M' %}
                    <div class="form-horizontal" name="exam_question">
                          <li id='matching-{{ forloop.counter }}' class="form-group"> {{ question.prompt }} <b> (Points: {{ question.points }})</b></li>
                          <select class="form-group" name="matching_answer_field">
                            {% for item in section.matching_answers %}
                              <h5>{{ response|get_item:forloop.counter0 }}</h5>
                              <h5>{{ item }}</h5>
                              <option value="{{ item }}" {% if response|get_item:forloop.parentloop.counter0 == item %} selected {% endif %}>{{ item }}</option>
                            {% endfor %}
                          </select>
                    </div>
                  {% elif section.type == 'TF' %}
                    {% include 'exams/tf_question_template.html' %}
                  {% elif section.type == 'FB' %}
                    {% include 'exams/fitb_question_template.html' %}
                  {% endif %}
                {% endfor %}
              {% empty %}
                <i>No exam questions to view.</i><br />
              {% endfor %}
            </ol>
            <div class="pull-right">
              <button id="save_button" name="Save" class="btn btn-success">Save</button>
              <button id="finalize_button" name="Submit" class="btn btn-primary">
                Finalize
              </button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  {% else %}
    {% include "exams/exam_grade.html" %}
  {% endif %}
{% endblock %}


{% block scripts %}
  <script>
  function selectOnlyThis(id) {
    cur_id = '#' + id;
    var this_div = $(cur_id).closest("div");
    numeral = parseInt(id.match(/\d+/));
    if ((numeral % 2) === 0) {
        document.getElementById("tf_" + (numeral - 1).toString()).checked = false;
    } else {
      document.getElementById("tf_" + (numeral + 1).toString()).checked = false;
    }
    document.getElementById(id).checked = true;
  }

  function attach_counter(textarea, index) {
    Countable.live(textarea, function(counter){
      var span = $('#count-' + index);
      span.html(counter.words);
    });
  }

  $(document).ready(function(e) {
    // Attach Countable to essay questions
    var textareas = $('.exam-response');
    for (var i = 0; i < textareas.length; i++) {
      var textarea = textareas[i];
      var index = $(textarea).attr('id').split('-')[1];
      attach_counter(textarea, index);
    }

    $("#exam_form").on("click", '#save_button, #finalize_button', function (e){
      e.preventDefault();

      var form_data = $('#exam_form').serializeArray();
      //rtn_data = {SECTION_ID: {1:ANSWER1,2:ANSWER2,3:ANSWER3,...}, SECTION_ID: ...}
      var rtn_data = {};
      var current_ques_index = 1;
      var current_section_type = "none";
      var current_section_id;
      var current_fitb_index = 0;
      var r = /\d+/;
      for(var i=0; i < form_data.length; i++) {
        if (form_data[i].name == "section_id") {
          current_ques_index = 1;
          current_section_id = form_data[i].value;
          rtn_data[form_data[i].value] = {}; //create new object for section_id
        }
        if (form_data[i].name == "section_type") {
          current_section_type = form_data[i].value;
        }
        if (current_section_type == "essay" && form_data[i].name == "response") {
          rtn_data[current_section_id][current_ques_index] = form_data[i].value;
          current_ques_index += 1;
        } else if (current_section_type == "mc") {
          if (/[0-9]+/.test(form_data[i].name)) {
            //value includes question number, name(s) are the answers student inputted
            if (rtn_data[current_section_id][form_data[i].value] != undefined) {
              rtn_data[current_section_id][form_data[i].value] = rtn_data[current_section_id][form_data[i].value].concat(';').concat(form_data[i].name);
            } else {
              rtn_data[current_section_id][form_data[i].value] = form_data[i].name;
            }
          }
        } else if (current_section_type == "matching" && form_data[i].name == "matching_answer_field") {
            //BUG: every third time or random time the trainee saves it seems like some of the trainee responses gets messed up
            rtn_data[current_section_id][current_ques_index] = form_data[i].value;
            current_ques_index += 1;
        } else if (current_section_type == "tf") {
          if (/true[0-9]+/.test(form_data[i].name)) {
            rtn_data[current_section_id][current_ques_index] = 'true';
            current_ques_index += 1;
          } else if (/false[0-9]+/.test(form_data[i].name)) {
            rtn_data[current_section_id][current_ques_index] = 'false';
            current_ques_index += 1;
          }
        } else if (current_section_type == "fitb") {
          //check if form data name is a an answer textbox with the name: fitb-textarea-x
          if (/fitb-textarea-[0-9]+/.test(form_data[i].name)) {
            /** fitb index is the integer x in 'fitb-textarea-x', if x is less than current_fitb_index then it indicates
            a new question is reached and the fitb-textarea-x resets x to 1*/
            if (current_fitb_index >= parseInt(form_data[i].name.match(r))) {
              current_ques_index += 1;
            }
            current_fitb_index = parseInt(form_data[i].name.match(r));
            //if something in response of trainee already:
            if (rtn_data[current_section_id][current_ques_index] != undefined) {
              rtn_data[current_section_id][current_ques_index] = rtn_data[current_section_id][current_ques_index].concat(';').concat(form_data[i].value)
            } else {
              rtn_data[current_section_id][current_ques_index] = form_data[i].value;
            }
          }
        }
      }
      //rtn_data[e.target.name] ='true';
      if (e.currentTarget.id === "finalize_button") {
        rtn_data['Submit'] ='true';
      } else {
        rtn_data['Submit'] ='false';
      }
      $.ajax({
        type: 'POST',
        url: window.location.pathname,
        data: JSON.stringify(rtn_data),
        success: function (data, status, jqXHR) {
          if (rtn_data['Submit'] == 'true') {
            window.location = 'exams/manage';
          } else {
            location.reload();
          }
        },
        error: function (jqXHR, textStatus, errorThrown ) {
        }
      })

    })
  })
  </script>
{% endblock %}
