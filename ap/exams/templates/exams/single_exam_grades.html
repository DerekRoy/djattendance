{% extends "exams/base_exams.html" %}

{% load staticfiles %}
{% load exam_extras %}

{% block title %}Exam Grades{% endblock %}

{% block content %}

<h1>Exam Grades</h1>

{% if user.is_designated_grader or user.type == 'T' %}
    <form action="" method="post">
        {% csrf_token %}
    <div class="panel panel-default">
        <div class="panel-heading exam-panel-heading">
            <div class="btn-group pull-right grades-btn-group ">
                <a class="btn btn-default" href="{% url 'exams:list' %}">Back</a>
                <button type="submit" class="btn btn-success">Save grades</button>
            </div>
            <h3 class="panel-title exam-panel-title">Entering grades for {{ exam }}</h3>
        </div>
    </div>
    <table class="grades-table table-striped table table-condensed">
        <th class="grades-th">Trainee</th>
        <th class="grades-th">Exam 1</th>
        <th class="grades-th">Exam 2</th>
        <th class="grades-th">Available Actions</th>
        {% for trainee in data %}
            {% with trainee.current_sessions as sessions %}
            <tr>
                <td class="grades-td" style="vertical-align:middle;">{{ trainee.full_name2 }}</td>
                <td class="grades-td" style="vertical-align:middle;">
                    <!-- The following code is identical for this td and the next.  There are four cases:
                        (1) We have an exam for which grading has been finalized (exam grade inputed via input box or finalization on grading page), so display only the score.
                        (2) We have an exam that was submitted online and can be graded online, so display a link to grade the exam.
                        (3) The exam was not submitted online but has been graded, so display the score in a box.
                        (4) The exam was not submitted online and has not yet been graded (i.e., we don't know about it yet), so display an empty box.

                    The reason that (3) and (4) are separated is to reduce after-post processing on the views side.-->
                    {% if sessions.0.is_graded %}
                        {{ sessions.0.grade }}
                    {% elif sessions.0 and sessions.0.is_submitted_online %}
                        <a href="{% url 'exams:grade' sessions.0.id %}">{{ sessions.0|link_text }}</a>
                    {% elif sessions.0 %}
                        <input type="hidden" name="session-id" value="{{ sessions.0.id }}" />
                        <input cols="20" name="session-id-grade" value="{{ sessions.0.grade }}" class="score form-control" />
                    {% else %}
                        <input type="hidden" name="trainee-id" value="{{ trainee.id }}" />
                        <input cols="20" name="new-grade" placeholder="Grade for paper response." value="" class="score form-control" />
                    {% endif %}

                    {% if sessions.0 and sessions.0.is_graded %}
                        | <a href="javascript:unfinalize_grade({{sessions.0.id}})">Unfinalize Exam</a>
                    {% endif %}

                    {% if sessions.0 %}
                        | <a href="javascript:delete_exam({{sessions.0.id}})">Delete Exam</a>
                    {% endif %}
                </td>
                <td class="grades-td" style="vertical-align:middle;">
                    {% if sessions.1.is_graded %}
                        {{ sessions.1.grade }}
                    {% elif sessions.1 != None and sessions.1.is_submitted_online %}
                        <a href="{% url 'exams:grade' sessions.1.id %}">{{ sessions.1|link_text }}</a>
                    {% elif sessions.1 != None %}
                        <input type="hidden" name="session-id" value="{{ sessions.1.id }}" />
                        <input cols="20" name="session-id-grade" value="{{ sessions.1.grade }}" class="score form-control" />
                    {% else %}
                        <input type="hidden" name="trainee-id" value="{{ trainee.id }}" />
                        <input cols="20" name="new-grade" placeholder="Grade for paper response." value="" class="score form-control" />
                    {% endif %}

                    {% if sessions.1 != None and sessions.1.is_graded %}
                        | <a href="javascript:unfinalize_grade({{sessions.1.id}})">Unfinalize Exam</a>
                    {% endif %}

                    {% if sessions.1 != None %}
                        | <a href="javascript:delete_exam({{sessions.1.id}})">Delete Exam</a>
                    {% endif %}
                </td>
                <td class="grades-td" style="vertical-align:middle;">
                    {% if sessions.1 == None %}
                        <a href="javascript:open_for_retake({{ trainee.id }})">Open for makeup/retake</a>
                    {% endif %}
                </td>
            </tr>
        {% endwith %}
        {% empty %}
            <i>No exam grades to view.</i>
        {% endfor %}
    </table>
    <br/>
    <button type="submit" value="Save" class="btn btn-success">Save</button>
    </form>

    <!-- hidden forms for delete, unfinalize, and retake -->
    <form action="" method="post" id="hidden-form">
        {% csrf_token %}
    </form>
{% else %}
<i>Sorry, you cannot view exam grades.</i>
{% endif %}

{% endblock %}

{% block scripts %}
    <script src="{% static 'exams/js/local-post.js' %}"></script>
{% endblock %}
