{% extends "base.html" %}
{% load staticfiles %}

{% block scripts %}
  <script type="text/javascript" src="{% static "js/jquery.seat-charts.js" %}"></script>
  <script type="text/javascript" src="{% static "js/jquery.autocomplete.js" %}"></script>
{% endblock %}
{% block references %}
  <link rel="stylesheet" type="text/css" href="{% static 'seating/seating.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'seating/jquery.seat-charts.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'seating/jquery.autocomplete.css' %}" />
{% endblock %}


{% block content %}
<h2>Edit Seating Chart</h2>
<div class="alert alert-success" id="chart-submit-success" role="alert">Successfully updated seating chart</div>
<div class="alert alert-danger" id="chart-submit-error" role="alert"></div>
<div>
  <div class="form-inline">
    <form id="width-height-form">
      <label for="width">Width</label>
      <input type="number" class="form-control" id="width" min="1"/>
      <label for="height">Height</label>
      <input type="number" class="form-control" id="height" min="1"/>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
    <form id="submit-chart-form">
      <label for="chart-name">Name</label>
      <input type="text" class="form-control" id="chart-name" maxlength="100"/>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
  </div>
</div>
<div id="seat-map"></div>

<script>
  var trainees = JSON.parse('{{trainees_bb}}'.replace(/&#39;/g, "'").replace(/&quot;/g,'"'));
  var traineeNames = {};
  for (var i = 0; i < trainees.length; i++) {
    var name = trainees[i].firstname + ' ' + trainees[i].lastname;
    traineeNames[name] = trainees[i].id;
  }
  // trainees = null;

  var chart = JSON.parse('{{chart_bb}}'.replace(/&#39;/g, "'").replace(/&quot;/g,'"'));
  chart = chart[0];
  var chartId = {{chart_id}}
  var seatsJSON = JSON.parse('{{seats_bb}}'.replace(/&#39;/g, "'").replace(/&quot;/g,'"'));

  function Grid(width, height) {
    var g = [];
    for (var i = 0; i < height; i++) {
      g.push([]);
      for (var j = 0; j < width; j++) {
        g[i].push('');
      }
    }
    this.grid = g;
    this.width = width;
    this.height = height;
  }

  Grid.prototype = {
    constructor: Grid,
    addRow: function () {
      var newRow = [];
      for (var i = 0; i < this.width; i++) {
        newRow.push('');
      }
      this.grid.push(newRow);
      this.height += 1;
    },
    addColumn: function () {
      for (var i = 0; i < this.height; i++) {
        this.grid[i].push('');
      }
      this.width += 1;
    },
    removeRow: function() {
      this.height -= 1;
      this.grid.length = this.height;
    },
    removeColumn: function() {
      this.width -= 1;
      for (var i = 0; i < this.height; i++) {
        this.grid[i].length = this.width;
      }
    }
  }

  var seats = new Grid(chart.width, chart.height);
  var seatNames = new Grid(chart.width, chart.height);

  for (var i = 0; i < seatsJSON.length; i++) {
    var pk = seatsJSON[i].trainee;
    seats.grid[seatsJSON[i].y][seatsJSON[i].x] = pk;
    for (var j = 0; j < trainees.length; j++) {
      if (pk == trainees[j].id) {
        seatNames.grid[seatsJSON[i].y][seatsJSON[i].x] = trainees[j].firstname + ' ' + trainees[j].lastname;
      }
    }
  }

  var map = [];
  for (var i = 0; i < chart.height; i++) {
    map.push('a'.repeat(chart.width));
  }

  var scObject = {
    map: map,
    seats: {},
    naming: {
      top: true,
      left: true,
    },
    click: function (event) {
      if (this.status() == 'available') {
        $("#edit-seat").remove();
        console.log(this.data());
        console.log(this.settings);

        var seatId = "#" + this.settings.id;
        var positioningStyle = "top:" + this.settings.$node[0].offsetTop + "px; left:" + this.settings.$node[0].offsetLeft + "px;";
        $(seatId).after('<form class="form-inline" id="edit-seat" style="' + positioningStyle + '">');
        $("#edit-seat").append('<input class="form-control" id="trainee-name"/>');
        $("#edit-seat").append('<button id="" type="submit" class="btn btn-xs btn-default">Submit</button>');

        $("#trainee-name").focus();

        $("#trainee-name").autocomplete({
            lookup: Object.keys(traineeNames),
            autoSelectFirst: true,
        });
        var row = this.settings.row;
        var column = this.settings.column;
        $("#edit-seat").submit(function(event) {
          event.preventDefault();
          var tn = $("#trainee-name").val();
          console.log(tn);
          $(seatId).text(tn);
          seats.grid[row][column] = traineeNames[tn] ? traineeNames[tn] : tn;
          seatNames.grid[row][column] = tn;
          $("#edit-seat").remove();
          $(".selected").focus();
          if (tn == '') {
            $(".selected").removeClass("selected");
            return 'selected';
          }
        });

        // console.log(seats);

        $(".selected").removeClass("selected");
              
        return 'selected';
      } else if (this.status() == 'selected') {
        //seat has been vacated
        return 'available';
      } else if (this.status() == 'unavailable') {
        //seat has been filled
        return 'unavailable';
      } else {
        return this.style();
      }
    }
  }

  $(document).ready(function() {
    $("#submit-chart-form").show();
    $("#chart-name").val(chart.name);
    $("#width").val(chart.width);
    $("#height").val(chart.height);

    var sc = $('#seat-map').seatCharts(scObject);

    for (var i = 0; i < chart.height; i++) {
      for (var j = 0; j < chart.width; j++) {
        var id = (i+1) + '_' + (j+1);
        if (i <= seats.grid.length) {
          if (j <= seats.grid[i].length && seatNames.grid[i][j] != '') {
            // console.log(seatNames.grid[i][j]);
            // console.log(id);
            sc.get(id).node().text(seatNames.grid[i][j]);
          }
        }
      }
    }

    //to hide edit seat form
    $(document).mouseup(function (e) {
        var container = $(".seatCharts-cell");
        var form = $("#edit-seat")

        // if the target of the click isn't the container nor a descendant of the container or the form
        if ((!container.is(e.target) && container.has(e.target).length === 0) &&
              (!form.is(e.target) && form.has(e.target).length === 0))
        {
          $("#edit-seat").remove();
        }
    });

    $("#width-height-form").submit(function (event) {
      event.preventDefault();

      $('#seat-map').empty();

      var w = parseInt($("#width").val());
      var h = parseInt($("#height").val());
      $("#seat-map").css("width", ((w+2)*60).toString() + "px");

      var map = [];
      for (var i = 0; i < h; i++) {
        map.push('a'.repeat(w));
      }

      scObject.map = map
      sc = $('#seat-map').seatCharts(scObject);

      if (w > seats.width) {
        while (seats.width != w) {
          console.log(seats.width);
          seats.addColumn();
          seatNames.addColumn();
        }
      } else {
        while (seats.width != w) {
          console.log(seats.width);
          seats.removeColumn();
          seatNames.removeColumn();
        }
      }

      if (h > seats.height) {
        while (seats.height != h) {
          seats.addRow();
          seatNames.addRow();
        }
      } else {
        while (seats.height != h) {
          seats.removeRow();
          seatNames.removeRow();
        }
      }
      
      for (var i = 0; i < h; i++) {
        for (var j = 0; j < w; j++) {
          var id = (i+1) + '_' + (j+1);
          if (i <= seats.grid.length) {
            if (j <= seats.grid[i].length && seatNames.grid[i][j] != '') {
              // console.log(seatNames.grid[i][j]);
              // console.log(id);
              sc.get(id).node().text(seatNames.grid[i][j]);
            }
          }
        }
      }
    });

    $("#submit-chart-form").submit(function (event) {
      event.preventDefault();
      if (seats.grid.length > 0) {
        var chart = {
          id: chartId,
          name: $("#chart-name").val(),
          desc: '',
          width: $("#width").val(),
          height: $("#height").val(),
          trainees: seats.grid,
        }

        $.ajax({
          url: '/api/charts/',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(chart),
          success: function (data, status, jqXHR) {
            console.log('SUCCESS', status);
            console.log(data, jqXHR);
            $("#chart-submit-error").hide();
            $("#chart-submit-success").show();
            setTimeout(function() {
              $("#chart-submit-success").slideUp(1000)
            }, 5000);
          },
          error: function (jqXHR, textStatus, errorThrown ) {
            console.log('Chart post error!');
            console.log(jqXHR, textStatus, errorThrown);
            $("#chart-submit-error").show();
            $("#chart-submit-error").empty();
            $("#chart-submit-error").append('Error! ' + errorThrown);
          }
        })
      }
    });

  });
</script>

{% endblock %}
