{% extends "base.html" %}
{% load staticfiles %}

{% block scripts %}
  <script type="text/javascript" src="{% static "js/jquery.seat-charts.js" %}"></script>
  <script type="text/javascript" src="{% static "js/jquery.autocomplete.js" %}"></script>
{% endblock %}
{% block references %}
  <link rel="stylesheet" type="text/css" href="{% static 'seating/seating.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'seating/jquery.seat-charts.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'seating/jquery.autocomplete.css' %}" />
{% endblock %}


{% block content %}
<h2>Create Seating Chart</h2>
<div>
  <div class="form-inline">
    <form id="width-height-form">
      <label for="width">Width</label>
      <input type="number" class="form-control" id="width"/>
      <label for="height">Height</label>
      <input type="number" class="form-control" id="height"/>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
    <form id="submit-chart-form">
      <label for="chart-name">Name</label>
      <input type="text" class="form-control" id="chart-name"/>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
  </div>
</div>
<div id="seat-map"></div>

<script>
  var traineeNames = [
    'David Tien', 'Ray Li', 'Ruiyu Wu', 'Sam Chai', 'Leonard Lan', 'Danny Cain', 'Rochelle Wang', 'Amaris Chen', 'Isaac Choo', 'Christine Zhao', 'Lisa Dina', 'Ryan Hsu', 'Ugo Ibe', 'Kaleb Goodwin', 'Eliza Li', 'Tiff Chu', 'Crystal Mandudi', 'Zoe Cao', 'Michaela Lai', 'Madeline Shapiro', 'John Gim', 'Hailey Lin'
  ]

  $(document).ready(function() {
    seats = [];

    //to hide edit seat form
    $(document).mouseup(function (e) {
        var container = $(".seatCharts-cell");
        var form = $("#edit-seat")

        // if the target of the click isn't the container nor a descendant of the container or the form
        if ((!container.is(e.target) && container.has(e.target).length === 0) &&
              (!form.is(e.target) && form.has(e.target).length === 0))
        {
          $("#edit-seat").remove();
        }
    });

    $("#width-height-form").submit(function (event) {
      $('#seat-map').empty();
      $("#submit-chart-form").show();

      event.preventDefault();
      var w = $("#width").val();
      var h = $("#height").val();
      $("#seat-map").css("width", ((parseInt(w)+2)*60).toString() + "px");

      var map = []
      for (var i = 0; i < h; i++) {
        map.push('a'.repeat(w));
        seats.push([]);
        for (var j = 0; j < w; j++) {
          seats[i].push('');
        }
      }

      var sc = $('#seat-map').seatCharts({
        map: map,
        seats: {
          a: {
            // price   : 99.99,
            // classes : 'spacing' //your custom CSS class
          }

        },
        naming: {
          top: true,
          left: true,
        },
        click: function (event) {
          if (this.status() == 'available') {
            $("#edit-seat").remove();
            console.log(this.data());
            console.log(this.settings);

            var seatId = "#" + this.settings.id;
            var positioningStyle = "top:" + this.settings.$node[0].offsetTop + "px; left:" + this.settings.$node[0].offsetLeft + "px;";
            $(seatId).after('<form class="form-inline" id="edit-seat" style="' + positioningStyle + '">');
            $("#edit-seat").append('<input class="form-control" id="trainee-name"/>');
            $("#edit-seat").append('<button id="" type="submit" class="btn btn-xs btn-default">Submit</button>');

            $("#trainee-name").focus();

            $("#trainee-name").autocomplete({
                lookup: traineeNames,
                autoSelectFirst: true,
            });
            var trainee = null; //global variable
            var row = this.settings.row;
            var column = this.settings.column;
            $("#edit-seat").submit(function(event) {
              event.preventDefault();
              console.log($("#trainee-name").val());
              $(seatId).text($("#trainee-name").val());
              seats[row][column] = $("#trainee-name").val();
              $("#edit-seat").remove();
              $(".selected").focus();
            });

            console.log(seats);

            $(".selected").removeClass("selected");
                  
            return 'available';
          } else if (this.status() == 'selected') {
            //seat has been vacated
            return 'available';
          } else if (this.status() == 'unavailable') {
            //seat has been already booked
            return 'unavailable';
          } else {
            return this.style();
          }
        }
      });

      //Make all available 'c' seats unavailable
      sc.find('c.available').status('unavailable');

      /*
      Get seats with ids 2_6, 1_7 (more on ids later on),
      put them in a jQuery set and change some css
      */
      sc.get(['2_6', '1_7']).node().css({
      });

      console.log('Seat 1_2 costs ' + sc.get('1_2').data().price + ' and is currently ' + sc.status('1_2'));
    });

    $("#submit-chart-form").submit(function (event) {
      event.preventDefault();
      if (seats.length > 0) {
        var chart = {
          name: $("#chart-name").val(),
          desc: '',
          height: $("#width").val(),
          width: $("#height").val(),
          trainees: seats,
        }

        $.ajax({
          url: '/api/charts/',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(chart),
          success: function (data, status, jqXHR) {
            console.log('SUCCESS', status);
            console.log(data, jqXHR);
          },
          error: function (jqXHR, textStatus, errorThrown ) {
            console.log('Chart post error!');
            console.log(jqXHR, textStatus, errorThrown);
          }
        })
      }
    });

  });
</script>

{% endblock %}
