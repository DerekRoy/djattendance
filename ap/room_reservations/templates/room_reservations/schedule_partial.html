<script>
//globals
var reservation_list = {{reservations|safe}};
var rooms_list = {{rooms_list|safe}};
var bro_rooms_list = {{bro_rooms_list|safe}};
var sis_rooms_list = {{sis_rooms_list|safe}};
var times_list = {{times_list|safe}};
var today = new Date();
var blank_cell = '<td>&nbsp</td>';
var blank_row = '';
var which_rooms = rooms_list;
var selected_date = '';
var data_table;
var data_table_options = {
  select: {
    style: 'multi',
    items: 'cell',
    selector: 'td:not(:first-child)'
  }
};

$(document).ready(function() {
  /*** Initialize Schedule ***/
  selected_date = today;

  /* Initialize checkboxes */
  checkboxes = $(":checkbox");
  checkboxes[0].checked = false;
  checkboxes[1].checked = false;

  /* Initialize Datepicker  */
  $('.datepicker').datepicker({
    changeMonth: true,
    changeYear: true,
    onSelect: function(selected) {
      let selected_mom = moment(selected, "MM/DD/YYYY");
      selected_date = selected_mom;
      data_table.clear();
      generateBody(selected_mom, which_rooms);
    }
  });
  $('.datepicker').datepicker('setDate', selected_date);

  /* Initialize Datatable */
  $.extend(true, $.fn.dataTable.defaults, {
    //https://datatables.net/manual/options
    "paging": false,
    "searching": false,
    "ordering": false,
    "scrollY": '60vh',
    "scrollX": true
  });
  generateHeader(which_rooms);
  data_table = $('#schedule-table').DataTable(data_table_options);
  generateBody(selected_date, which_rooms);

  /* Listen for checkboxes */
  checkboxes.change(function() {
    if(checkboxes[0].checked) {
      console.log(bro_rooms_list);
      which_rooms = bro_rooms_list;
    }
    if(checkboxes[1].checked) {
      console.log(sis_rooms_list);
      which_rooms = sis_rooms_list;
    }
    if(checkboxes[0].checked == checkboxes[1].checked){
      which_rooms = rooms_list;
    }

    //reset html table
    data_table.destroy();
    $('tbody').empty();
    $('thead').empty();
    generateHeader(which_rooms);
    data_table = $('#schedule-table').DataTable(data_table_options);
    generateBody(selected_date, which_rooms);
  });

});

/** FUNCTIONS **/
  function generateHeader(list_of_rooms){
    //generate first row
    $("#schedule>table>thead").append("<tr><th>Time Slots</th></tr>");
    for(i=0; i<list_of_rooms.length; i++){
      $("#schedule>table>thead>tr").append("<th>"+list_of_rooms[i].pk+"</th>");
    }
  }

  function getRelevantReservations(date){
    /* Determines which rooms are reserved for the given date */
    new_arr = [];
    selected_date = moment(date)._d.toLocaleDateString();
    selected_date_mom = moment(date);
    for (i=0; i<reservation_list.length; i++) {
      reservation = reservation_list[i];
      isReserved = false;

      reservation_date = moment(reservation.fields.date)._d.toLocaleDateString();
      reservation_date_mom = moment(reservation.fields.date);

      if (reservation_date == selected_date) {
        isReserved = true;
      } else {
        if (reservation.fields.frequency == "Term") {
          if (reservation_date_mom.isBefore(selected_date_mom)){
            diff = selected_date_mom.diff(reservation_date_mom, 'days');
            if (diff % 7 == 0) {
              isReserved = true; //weekly
            }
          }
        }
      }

      if (isReserved) {
        /* Converts time formats to integers for easy tabling */
        start_split = reservation.fields.start.split(':');
        end_split = reservation.fields.end.split(':');
        reservation_start = parseInt(start_split[0]);
        reservation_end = parseInt(end_split[0]);
        if (parseInt(start_split[1])) {
          reservation_start += 0.5;
        }
        if (parseInt(end_split[1])) {
          reservation_end += 0.5;
        }

        //creates new properties - slot_start & slot_end
        reservation.fields.slot_start = reservation_start * 2;
        reservation.fields.slot_end = reservation_end * 2 - 1;

        new_arr.push(reservation);
      }
    }
    return new_arr;
  }

  function generateBody(date, list_of_rooms){
    row = [];
    noReservations = false;
    relevant_reservations = getRelevantReservations(date);
    reset_row = [];

    //generates [nbsp, nbsp, ..., nbsp]
    for(i=0; i<list_of_rooms.length+1;i++) reset_row.push('&nbsp');

    if (relevant_reservations.length == 0) noReservations = true;

    row = reset_row.slice(0);
    if (noReservations) {
      //create rows of empty cells
      for(i=0; i<times_list.length; i++){
        row[0] = times_list[i];
        data_table.row.add(row);
      }
    } else {
      //iterate through rows
      for(i=0; i<times_list.length; i++){
        row[0] = times_list[i];

        //iterate through columns, make a copy of reservations
        temp = relevant_reservations.slice(0);
        for(j=0; j<list_of_rooms.length; j++){
          room = list_of_rooms[j].pk;

          for(k=0; k<temp.length; k++){
            reservation = temp[k];

            if(room == reservation.fields.room){
              if(i >= reservation.fields.slot_start && i <= reservation.fields.slot_end) {
                //update row element with group name and remove reservation from list
                row[j+1] = reservation.fields.group;
                temp.splice(k,1);
                break;
              }
            }

          }
        }
        data_table.row.add(row);
        row = reset_row.slice(0);
      }
    }
    data_table.draw();
  }

</script>

<div>
  <label>Date &nbsp;</label>
  <input class="datepicker" placeholder="Date" title="" type="text" />
  <label>Access Types: </label>
  <input type="checkbox" name="filter" value="Brothers"/>Brothers &nbsp;
  <input type="checkbox" name="filter" value="Sisters"/>Sisters &nbsp;
</div>
<div class="row">
  <div id="schedule" class="col-md-12">
    <table id="schedule-table"class="table">
      <thead>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
