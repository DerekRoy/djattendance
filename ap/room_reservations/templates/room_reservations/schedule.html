{% extends "base.html" %}

{% load staticfiles %}
{% load bootstrap3 %}

{% block content %}
<h2>Room Reservation Schedule </h2>
<div><label>Date &nbsp</label><input class="datepicker" id="id_date" name="date" placeholder="Date" title="" type="text" /></div>
<div class="row">
  <div id="schedule" class="col-md-12 col-xs-12">
    <table id="schedule-table"class="table">
      <thead>
        <tr id="head-row">
	  <th>Time Slots</th>
	</tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>


<script>
var reservation_list = {{reservations|safe}};
var rooms_list = {{rooms_list|safe}};
var times_list = {{times_list|safe}};
var today = new Date();

$(document).ready(function() {

  createBlankSchedule();
  $("tr:even").css("background-color", "#F0F0F0");
  $("td").css("border-right", "1px solid black");
  $('.datepicker').datepicker({
    changeMonth: true,
    changeYear: true,
    onSelect: function(selected,evnt) {
      updateScheduleTable(selected);
    }
  });
  $('.datepicker').datepicker('setDate', today);
  
  updateScheduleTable(today);

  /** FUNCTIONS **/
  function updateScheduleTable(value){
    selected_date = moment(value.toString())._d.toLocaleDateString();
    
    for(i=0; i<reservation_list.length; i++){
      reservation = reservation_list[i];
      reservation_date = moment(reservation.fields.date)._d.toLocaleDateString();
      if(reservation_date == selected_date){
	start_split = reservation.fields.start.split(':');
	end_split = reservation.fields.end.split(':');
	reservation_start = parseInt(start_split[0]);
	reservation_end = parseInt(end_split[0]);
	if (parseInt(start_split[1])) reservation_start += 0.5;
	if (parseInt(end_split[1])) reservation_end += 0.5;
	time_slots = (reservation_end - reservation_start)*2;
	col_ind = 0;
	for(k=0; k<rooms_list.length; k++){
          if(reservation.fields.room == rooms_list[k].pk) col_ind = k+1;
	}
	console.log('col_ind');
	console.log(col_ind);
	for(j=0; j<time_slots; j++){
	  $("tbody>tr")[reservation_start*2 + j].children[col_ind].append(reservation.fields.group);
	}
	console.log('start');
	console.log(reservation_start);
        console.log('time_slots');
	console.log(time_slots);
      }
     //convert duration to time slots
     //find row where reservation begins
     //replance &nbsp with pk for # of time slots
    }
  }

  function createBlankSchedule(){
    /* create table for schedule */
    var blank_cell = '<td>&nbsp</td>';
    var blank_row = '';

    for(i=0; i<rooms_list.length; i++){
      $("#schedule-table>thead>tr").append("<th>"+rooms_list[i].pk+"</th>");
      blank_row += blank_cell;
    }

    for(i=0; i<times_list.length-1; i++){
      $("tbody").append("<tr><td>"+times_list[i]+"-"+times_list[i+1]+"</td>"+blank_row+"</tr>");
    }    
  }

});
</script>
{% endblock %}

