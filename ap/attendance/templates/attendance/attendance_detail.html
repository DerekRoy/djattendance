{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% bootstrap_messages %}
{% block references %}
    <link href="{% static "css/schedule.css" %}" rel="stylesheet">
    <link href="{% static "css/attendance.css" %}" rel="stylesheet">
{% endblock %}

{% block content %}
    <h2>{{ trainee }}'s Schedule</h2><br>
    <div id="clndr">
    </div>

    <!-- SCHEDULE TEMPLATE -->
    <script type="text/template" id="clndr-template">
        <div class="btn-toolbar" role="toolbar">
            <div class="controls btn-group">
                <button class="btn btn-info"><span class="glyphicon glyphicon-calendar"></span></button>
            </div>
            <div class="controls btn-group">
                <button class="btn btn-default clndr-previous-button">Prev</button>
                <div class="daterange btn btn-default disabled">
                    <%= extras.currentWeek.startOf('week').format('M/D/YY') %> to <%= extras.currentWeek.endOf('week').format('M/D/YY') %>
                </div>
                <button class="btn btn-default clndr-next-button">Next</button>
            </div>
        </div>

        <hr>

        <!-- DAY/DATE BAR -->
        <div class="row">
            <div class="col-md-1">
            </div>
            <% for(var i = extras.currentWeek.startOf('week').clone(); i.isBefore(extras.currentWeek.endOf('week')); i.add('d', 1)) { %>
                <% var day = _.findWhere(days, {day: i.date()}) %>
                <div class=" col-md-1">
                    <div class="schedule-header <%= day.classes %>"  id="<%= day.id %>">
                        <%= day.date.format("ddd") %> <br>
                        <%= day.date.format("M/D") %>
                    </div>
                </div>
            <% } %>
            <div class="col-md-4">

            </div>
        </div>

        <div class="row">

            <!-- TIMEBAR -->
            <div class="col-md-1 timebar">
                <% for(var i = 6; i < 24; i++) { %>
                    <div class="hour"><%= moment({hour: i}).format("h A") %></div>
                <% } %>
            </div>

            <!-- EVENTS -->
            <% for(var i = extras.currentWeek.startOf('week').clone(); i.isBefore(extras.currentWeek.endOf('week')); i.add('d', 1)) { %>
                <% var day = _.findWhere(days, {day: i.date()}) %>
                <div class="<%= day.classes %> col-md-1">
                    <% _.each(day.events, function(event) { %>
                        <div class="schedule-event <%= event.roll %> <%= event.status %>"
                             style="top: <%= moment.duration(moment(event.start).format('H:m')).subtract(6, 'hours').asMinutes()/2 %>px;
                                    height: <%= moment(event.end).diff(moment(event.start), 'minutes')/2 %>px "
                            data-id=<%= event.id %> >
                            <%= event.code %>
                        </div>
                    <% }); %>
                </div>
            <% } %>

            <div class="col-md-4">
                <!-- SUBMIT ROLL -->
                <div class="panel panel-default" id="submit-roll">
                  <div class="panel-heading">
                    <h3 class="panel-title" id="event-title">Submit Roll</h3>
                  </div>
                  <div class="panel-body" id="event-info">
                        <button id="present" type="button" class="btn btn-default btn-block">Present</button>
                        <button id="absent" type="button" class="btn btn-danger btn-block">Absent</button>
                        <button id="tardy" type="button" class="btn btn-warning btn-block">Tardy</button>
                        <button id="uniform" type="button" class="btn btn-warning btn-block">Uniform</button>
                        <button id="left-class" type="button" class="btn btn-warning btn-block">Left Class</button>
                  </div>
                </div>

                <!-- SUBMIT A LEAVE SLIP -->
                <div class="panel panel-default" id="submit-leaveslip">
                    <div class="panel-heading">
                        <h3 class="panel-title" id="event-title">Submit Leave Slip</h3>
                    </div>
                    <div class="panel-body" id="event-info">
                        <form id="leaveslip-form">{% csrf_token %}
                            {% bootstrap_form leaveslipform %}
                            <input type="hidden" id="id_trainee" name="trainee" value="{{ trainee.id }}">
                            <input type="hidden" id="id_TA" name="TA" value="{{ trainee.TA.id }}">

                            {% buttons %}
                                <button type="submit" class="btn btn-primary">
                                    Submit
                                </button>
                            {% endbuttons %}
                        </form>
                    </div>
                </div>
            </div>       
        </div>

    </script>

    <script type="text/javascript" src="{% static "js/clndr-week.js" %}"></script>

    <script type="text/javascript">
        clndr.options.constraints = {
            startDate: "{{ schedule.term.start | date:'Y-m-d' }}",
            endDate: "{{ schedule.term.end | date:'Y-m-d' }}"
        };

        var events = [
            {% for event in schedule.events.all %}
                {
                    id: "{{ event.id }}",
                    date: "{{ event.start | date:'Y-m-d'}}",
                    start: "{{ event.start | date:'r' }}",
                    end: "{{ event.end | date:'r' }}",
                    name: "{{ event.name }}",
                    code: "{{ event.code }}",
                    type: "{{ event.type }}",
                    slips: [],
                    status: "",
                },{% endfor %}
                {}]

        {% for roll in attendance %}
            _.findWhere(events, {id: "{{ roll.event.id }}" }).roll = "{{ roll.get_status_display|slugify }}";
        {% endfor %}

        {% for slip in leaveslips %}
            {% for event in slip.events.all %}
                var event = _.findWhere(events, {id: "{{ event.id }}" })
                event.slips.push({{slip.id}})
                if(event.status != "approved") {
                    event.status = "{{ slip.get_status_display | slugify }}"
                }
            {% endfor %}
        {% endfor %}

        clndr.addEvents(events);

        $( document ).ready(function() {

            var selected_events = [];
            var base_url = window.location.protocol + "//" + window.location.host + "/";

            /**
             * Calls the leaveslips API
             * @param {JSON} data 
             * @param {string} type - PUT, GET, POST
             * @return {bool} success
             */
            function sendAttendance(form_data, request_type) {
                // TODO: handle group / vs individual slips
                var data = JSON.stringify(form_data);
                console.log(data);

                errors = $.ajax({
                  url: base_url + 'leaveslip-api/individualslip/',
                  type: request_type,
                  contentType: 'application/json',
                  data: data,
                  dataType: 'json',
                  processData: false
                });

                console.log(errors);
            }

            /**
             * Calls the roll API - called immediately after clicking roll button
             * @param {integer array} event ids
             * @param {string} status 
             */
            function sendRoll(event_ids, status) {

            }

            $("#submit-leaveslip form").submit(function(event) {
                console.log('Preparing to submit leave slip with: ');
                console.log(selected_events);

                form_data = {
                    "comments": $(this).find("textarea#id_comments").val(),
                    "description": $(this).find("textarea#id_description").val(), 
                    "informed": $(this).find("input#id_informed").is(":checked"), 
                    "texted": $(this).find("input#id_texted").is(":checked"),
                    "type": $(this).find("select#id_type").val(),
                    "events": selected_events,
                    "trainee": base_url + 'leaveslip-api/trainee/' + $(this).find("input#id_trainee").val() + "/",
                    "TA": base_url + 'leaveslip-api/TA/' + $(this).find("input#id_TA_id").val() + "/",
                };

                console.log(form_data);
                sendAttendance(form_data, "POST", false);
                return false;
            });

            $("#clndr").on("click", ".schedule-event", function() {
                $(this).toggleClass("selected-event");
            });


            $("#clndr").on("click", "#submit-roll button", function () {
                var status = $(this).attr('id')

                $(".selected-event").each(function() {
                    $(this).removeClass("present absent tardy uniform left-class selected-event");
                    $(this).addClass(status);
                    selected_events.push($(this).data("id"));
                });

                sendRoll(selected_events, status);

            });

        });

    </script>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static "js/underscore-min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/moment.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/clndr.min.js" %}"></script>
{% endblock %}
