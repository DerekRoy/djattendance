{% extends "base.html" %}
{% load jsonify %}
{% load staticfiles %}
{% load bootstrap3 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% bootstrap_messages %}
{% block references %}
<link href="{% static "schedules/schedule.css" %}" rel="stylesheet">
<link href="{% static "attendance/attendance.css" %}" rel="stylesheet">
{% endblock %}

{% block content %}
<h2>{{ trainee }}'s Schedule</h2><br>
<div id="leaveslip-alert" class="alert">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
</div>
<div id="react"></div>
<script type="text/javascript">
  /* render react after page loads */
  console.log('About to render react.js...');
  var a = function() {
    React.render(React.createElement(Attendance, {events: events, rolls: rolls, slips: slips}), document.getElementById('react'));
  };
  setTimeout(a, 1500);
</script>
{% endblock %}

{% block scripts %}
<!-- default libs -->
<script type="text/javascript" src="{% static "js/underscore-min.js" %}"></script>
<script type="text/javascript" src="{% static "js/moment.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/react/lib/backbone.min.js" %}"></script>

<script type="text/javascript" src="{% static "js/react/lib/react-with-addons.js" %}"></script>
<script type="text/javascript" src="{% static "js/react/lib/react.backbone.js" %}"></script>
<script type="text/javascript" src="{% static "js/react/lib/reflux.js" %}"></script>
<script type="text/javascript" src="{% static "js/react/lib/JSXTransformer.js" %}"></script>
<script type="text/javascript" src="{% static "js/react/stores/models.js" %}"></script>
<script type="text/javascript" src="{% static "js/react/stores/collections.js" %}"></script>

<script type="text/javascript">
  // using jQuery to do csrftoken adjustment
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
  }
  var csrftoken = getCookie('csrftoken');

  var oldSync = Backbone.sync;
  Backbone.sync = function(method, model, options){
    options.beforeSend = function(xhr){
      xhr.setRequestHeader('X-CSRFToken', csrftoken);
    };
    return oldSync(method, model, options);
  };

  //setup backbone models
  var events = new Events({{ events_bb | safe }});
  var rolls = new Rolls({{ attendance_bb | safe }});
  var slips = new Slips({{ leaveslips_bb | safe }});

  {% for roll in attendance %}
    events.get({{ roll.event.id }}).addRollID({{ roll.id }});
  {% endfor %}

  {% for slip in leaveslips %}
    {% for event in slip.events.all %}
      events.get({{ event.id }}).addSlipID({{slip.id}});
    {% endfor %}
  {% endfor %}
</script>

<!-- reflux -->
<script type="text/javascript" src="{% static "js/react/actions/actions.js" %}"></script>
<script type="text/javascript" src="{% static "js/react/stores/attendanceStore.js" %}"></script>
<script type="text/jsx" src="{% static "js/react/components/attendanceComponents.jsx" %}"></script>
<script type="text/jsx" src="{% static "js/react/views/attendanceView.jsx" %}"></script>

{% endblock %}