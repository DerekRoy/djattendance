{% extends "leaveslips/leaveslip_update.html" %}

{% block leaveslip_script %}
  <script>
  	var last_leaveslip_date = "{{last_leaveslip_date}}";
    var AttendanceRecord = {{attendance_record|safe}};
    
    var SelectedEvents = [
      {% for selected_event in selected %}
  	    {
  	      'title' : "{{selected_event.name|safe}}",
  	      'start' : "{{selected_event.start_datetime|date:'c'}}"
  	    },
      {% endfor %}
    ];  
	  
    var selected = {
      {% for event in leaveslip.events|dictsort:"start_datetime" %}
        "{{event.id}}": {
          'id': "{{event.id}}",
          'title' : "{{event.name}}",
          'start' : "{{event.start_datetime|date:'c'}}",
          'end' : "{{event.end_datetime|date:'c'}}"
        },
      {% endfor %}
    }
	
    for (var i=0; i < Events.length; i++){
      for (var j=0; j< SelectedEvents.length; j++){
        if(!Events[i].start.localeCompare(SelectedEvents[j].start)){
          Events[i].color = calendar_color['L'];
	    } 
      }
      for (var j=0; j< AttendanceRecord.length; j++){
	    if(!Events[i].start.localeCompare(AttendanceRecord[j].start)){
	      Events[i].color = calendar_color[AttendanceRecord[j].att];
	    }
      }
    }

    $(document).ready(function() {
      {% if leaveslip.events %}
        {% with leaveslip.events|first as event %}
        today = "{{event.date|date:'Y-m-d'}}";
        {% endwith %}
      {% endif %}
      events = $('#calendar').fullCalendar('clientEvents');
      for (var i=0; i<events.length; i++) {
        e = events[i];
        s = selected[e.id];
        if (s){
          if(e.start.isSame(s.start, 'day'))
            e.backgroundColor = "white";
        } else {
          e.backgroundColor = "";
        }
      }
      $('#calendar').fullCalendar('render');
      $('#calendar').fullCalendar('gotoDate', today);
      if ((leaveslip_type == 'MEAL') || (leaveslip_type == 'NIGHT')) {
        $('label[for="id_type"]').append("    (last " + leaveslip_type.toLowerCase() + " out: " + last_leaveslip_date + ")");
      }
    });
  </script>
{% endblock %}
